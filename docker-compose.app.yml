services:
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: sanctum-backend
    ports:
      - "127.0.0.1:8000:8000"
    environment:
      - QDRANT_HOST=qdrant
      - QDRANT_PORT=6333
      - EMBEDDING_PROVIDER=${EMBEDDING_PROVIDER:-local}
      - EMBEDDING_MODEL=${EMBEDDING_MODEL:-intfloat/multilingual-e5-base}
      - EMBEDDING_DIMENSIONS=${EMBEDDING_DIMENSIONS:-768}
      - HF_HUB_OFFLINE=${HF_HUB_OFFLINE:-0}
      - TRANSFORMERS_OFFLINE=${TRANSFORMERS_OFFLINE:-0}
      - OPENAI_API_KEY=${OPENAI_API_KEY:-}
      - LLM_PROVIDER=maple
      - MAPLE_BASE_URL=http://maple-proxy:8080/v1
      - MAPLE_API_KEY=${MAPLE_API_KEY:-}
      - MAPLE_MODEL=kimi-k2-thinking
      - SEARXNG_URL=http://searxng:8080
      - SQLITE_PATH=/data/sanctum.db
      # Magic Link Auth configuration
      - SECRET_KEY=${SECRET_KEY:-dev-secret-change-in-production}
      - FRONTEND_URL=${FRONTEND_URL:-http://localhost:5173}
      - MOCK_EMAIL=${MOCK_EMAIL:-true}
      # SMTP configuration (optional, not needed if MOCK_EMAIL=true)
      - SMTP_HOST=${SMTP_HOST:-}
      - SMTP_PORT=${SMTP_PORT:-587}
      - SMTP_USER=${SMTP_USER:-}
      - SMTP_PASS=${SMTP_PASS:-}
      - SMTP_FROM=${SMTP_FROM:-Sanctum <noreply@localhost>}
      # Simulation settings for development/testing
      - SIMULATE_USER_AUTH=${SIMULATE_USER_AUTH:-false}
      - SIMULATE_ADMIN_AUTH=${SIMULATE_ADMIN_AUTH:-false}
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:8000/health || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    depends_on:
      qdrant:
        condition: service_healthy
      maple-proxy:
        condition: service_healthy
      searxng:
        condition: service_healthy
    volumes:
      - ./backend/app:/app
      - ./uploads:/uploads
      - embedding_cache:/root/.cache/huggingface
      - sqlite_data:/data
    networks:
      - sanctum-net

  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    container_name: sanctum-frontend
    ports:
      - "127.0.0.1:5173:5173"
    dns:
      - 127.0.0.11  # Docker's embedded DNS server
    dns_opt:
      - attempts:3
      - timeout:2
    depends_on:
      backend:
        condition: service_healthy
    volumes:
      - ./frontend:/app
      - /app/node_modules
    networks:
      - sanctum-net

volumes:
  embedding_cache:
  sqlite_data:

networks:
  sanctum-net:
    driver: bridge
