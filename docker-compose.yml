services:
  maple-proxy:
    image: ghcr.io/opensecretcloud/maple-proxy:latest
    container_name: sanctum-maple-proxy
    ports:
      - "8080:8080"
    environment:
      - MAPLE_BACKEND_URL=https://enclave.trymaple.ai
      - MAPLE_API_KEY=${MAPLE_API_KEY}
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:8080/health || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 10s
    networks:
      - sanctum-net

  qdrant:
    image: qdrant/qdrant:v1.12.6
    container_name: sanctum-qdrant
    ports:
      - "6333:6333"  # HTTP
      - "6334:6334"  # gRPC
    volumes:
      - qdrant_data:/qdrant/storage
    healthcheck:
      test: ["CMD-SHELL", "timeout 5 bash -c '</dev/tcp/localhost/6333' || exit 1"]
      interval: 10s
      timeout: 10s
      retries: 5
      start_period: 10s
    networks:
      - sanctum-net

  searxng:
    image: searxng/searxng:latest
    container_name: sanctum-searxng
    volumes:
      - ./searxng:/etc/searxng:ro
    environment:
      - SEARXNG_BASE_URL=http://searxng:8080/
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://localhost:8080/healthz || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 15s
    networks:
      - sanctum-net

  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: sanctum-backend
    ports:
      - "8000:8000"
    environment:
      - QDRANT_HOST=qdrant
      - QDRANT_PORT=6333
      - EMBEDDING_PROVIDER=${EMBEDDING_PROVIDER:-local}
      - EMBEDDING_MODEL=${EMBEDDING_MODEL:-intfloat/multilingual-e5-base}
      - EMBEDDING_DIMENSIONS=${EMBEDDING_DIMENSIONS:-768}
      - OPENAI_API_KEY=${OPENAI_API_KEY:-}
      - LLM_PROVIDER=maple
      - MAPLE_BASE_URL=http://maple-proxy:8080/v1
      - MAPLE_API_KEY=${MAPLE_API_KEY:-}
      - MAPLE_MODEL=kimi-k2-thinking
      - SEARXNG_URL=http://searxng:8080
      - SQLITE_PATH=/data/sanctum.db
      # Magic Link Auth configuration
      - SECRET_KEY=${SECRET_KEY:-dev-secret-change-in-production}
      - FRONTEND_URL=${FRONTEND_URL:-http://localhost:5173}
      - MOCK_EMAIL=${MOCK_EMAIL:-true}
      # SMTP configuration (optional, not needed if MOCK_EMAIL=true)
      - SMTP_HOST=${SMTP_HOST:-}
      - SMTP_PORT=${SMTP_PORT:-587}
      - SMTP_USER=${SMTP_USER:-}
      - SMTP_PASS=${SMTP_PASS:-}
      - SMTP_FROM=${SMTP_FROM:-Sanctum <noreply@localhost>}
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:8000/health || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    depends_on:
      qdrant:
        condition: service_healthy
      maple-proxy:
        condition: service_healthy
      searxng:
        condition: service_healthy
    volumes:
      - ./backend/app:/app
      - ./uploads:/uploads
      - embedding_cache:/root/.cache/huggingface
      - sqlite_data:/data
    networks:
      - sanctum-net

  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    container_name: sanctum-frontend
    ports:
      - "5173:5173"
    environment:
      - VITE_DEV_MODE=${VITE_DEV_MODE:-true}
    dns:
      - 127.0.0.11  # Docker's embedded DNS server
    dns_opt:
      - attempts:3
      - timeout:2
    depends_on:
      backend:
        condition: service_healthy
    volumes:
      - ./frontend:/app
      - /app/node_modules
    networks:
      - sanctum-net

volumes:
  qdrant_data:
  embedding_cache:
  sqlite_data:

networks:
  sanctum-net:
    driver: bridge
